AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'CI/CD pipelines for SST SAM application with develop, qa, and main environments.

  '
Parameters:
  ApplicationName:
    Type: String
    Default: fourdistribution
    Description: The name of the application.
  ApplicationStageName:
    Type: String
    Default: cicd
    Description: The stage name for CI/CD resources.
  GitHubConnectionArn:
    Type: String
    Description: The ARN of the AWS CodeStar Connection to Github.
  GitHubRepoName:
    Type: String
    Description: The name of the Github repository (e.g., your-group/your-repo).
  ArtifactBucket:
    Type: String
    Description: The S3 bucket for storing pipeline artifacts.
Resources:
  CodePipelineRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName:
        Fn::Sub: ${ApplicationName}-${ApplicationStageName}-CodePipelineRole
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: codepipeline.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: CodePipelinePolicy
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action:
            - s3:GetObject
            - s3:GetObjectVersion
            - s3:PutObject
            - s3:ListBucket
            Resource:
            - Fn::Sub: arn:aws:s3:::${ArtifactBucket}
            - Fn::Sub: arn:aws:s3:::${ArtifactBucket}/*
          - Effect: Allow
            Action:
            - codestar-connections:UseConnection
            Resource:
              Ref: GitHubConnectionArn
          - Effect: Allow
            Action:
            - codebuild:StartBuild
            - codebuild:BatchGetBuilds
            Resource:
              Fn::GetAtt:
              - BuildProject
              - Arn
          - Effect: Allow
            Action:
            - cloudformation:CreateStack
            - cloudformation:UpdateStack
            - cloudformation:DescribeStacks
            - cloudformation:DescribeStackEvents
            - cloudformation:DescribeStackResources
            - cloudformation:GetTemplate
            Resource: '*'
          - Effect: Allow
            Action:
            - iam:PassRole
            Resource:
              Fn::GetAtt:
              - CloudFormationDeployRole
              - Arn
  CloudFormationDeployRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName:
        Fn::Sub: ${ApplicationName}-${ApplicationStageName}-CloudFormationRole
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: cloudformation.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: CloudFormationDeployPolicy
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action:
            - cloudformation:*
            - iam:*
            - lambda:*
            - s3:*
            - dynamodb:*
            - apigateway:*
            - cognito-idp:*
            - logs:*
            - events:*
            - states:*
            Resource: '*'
  BuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name:
        Fn::Sub: ${ApplicationName}-${ApplicationStageName}-build
      ServiceRole:
        Fn::GetAtt:
        - CodeBuildRole
        - Arn
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-x86_64-standard:5.0
        EnvironmentVariables:
        - Name: S3_BUCKET
          Value:
            Ref: ArtifactBucket
      Source:
        Type: CODEPIPELINE
        BuildSpec: cicd/infrastructure/buildspec.yml
  CodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName:
        Fn::Sub: ${ApplicationName}-${ApplicationStageName}-CodeBuildRole
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: codebuild.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: CodeBuildPolicy
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action:
            - s3:GetObject
            - s3:PutObject
            - s3:ListBucket
            Resource:
            - Fn::Sub: arn:aws:s3:::${ArtifactBucket}
            - Fn::Sub: arn:aws:s3:::${ArtifactBucket}/*
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource:
              Fn::Sub: arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${ApplicationName}-${ApplicationStageName}-build*
  DevelopPipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name:
        Fn::Sub: ${ApplicationName}-${ApplicationStageName}-develop-pipeline
      RoleArn:
        Fn::GetAtt:
        - CodePipelineRole
        - Arn
      ArtifactStore:
        Type: S3
        Location:
          Ref: ArtifactBucket
      Stages:
      - Name: Source
        Actions:
        - Name: SourceAction
          ActionTypeId:
            Category: Source
            Owner: AWS
            Provider: CodeStarSourceConnection
            Version: 1
          OutputArtifacts:
          - Name: SourceArtifact
          Configuration:
            ConnectionArn:
              Ref: GitHubConnectionArn
            FullRepositoryId:
              Ref: GitHubRepoName
            BranchName: develop
      - Name: Build
        Actions:
        - Name: BuildAndPackage
          ActionTypeId:
            Category: Build
            Owner: AWS
            Provider: CodeBuild
            Version: 1
          Configuration:
            ProjectName:
              Ref: BuildProject
          InputArtifacts:
          - Name: SourceArtifact
          OutputArtifacts:
          - Name: BuildArtifact
      - Name: Deploy
        Actions:
        - Name: DeployDev
          ActionTypeId:
            Category: Deploy
            Owner: AWS
            Provider: CloudFormation
            Version: 1
          InputArtifacts:
          - Name: BuildArtifact
          Configuration:
            ActionMode: CREATE_UPDATE
            StackName:
              Fn::Sub: ${ApplicationName}-dev
            TemplatePath: BuildArtifact::backend/sam/packaged.yaml
            TemplateConfiguration: BuildArtifact::cicd/configs/dev-config.json
            Capabilities: CAPABILITY_NAMED_IAM
            RoleArn:
              Fn::GetAtt:
              - CloudFormationDeployRole
              - Arn
  QAPipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name:
        Fn::Sub: ${ApplicationName}-${ApplicationStageName}-qa-pipeline
      RoleArn:
        Fn::GetAtt:
        - CodePipelineRole
        - Arn
      ArtifactStore:
        Type: S3
        Location:
          Ref: ArtifactBucket
      Stages:
      - Name: Source
        Actions:
        - Name: SourceAction
          ActionTypeId:
            Category: Source
            Owner: AWS
            Provider: CodeStarSourceConnection
            Version: 1
          OutputArtifacts:
          - Name: SourceArtifact
          Configuration:
            ConnectionArn:
              Ref: GitHubConnectionArn
            FullRepositoryId:
              Ref: GitHubRepoName
            BranchName: qa
      - Name: Build
        Actions:
        - Name: BuildAndPackage
          ActionTypeId:
            Category: Build
            Owner: AWS
            Provider: CodeBuild
            Version: 1
          Configuration:
            ProjectName:
              Ref: BuildProject
          InputArtifacts:
          - Name: SourceArtifact
          OutputArtifacts:
          - Name: BuildArtifact
      - Name: ApprovalForQA
        Actions:
        - Name: ManualApprovalForQA
          ActionTypeId:
            Category: Approval
            Owner: AWS
            Provider: Manual
            Version: 1
          Configuration:
            CustomData: Please review and approve deployment to QA environment
      - Name: Deploy
        Actions:
        - Name: DeployQA
          ActionTypeId:
            Category: Deploy
            Owner: AWS
            Provider: CloudFormation
            Version: 1
          InputArtifacts:
          - Name: BuildArtifact
          Configuration:
            ActionMode: CREATE_UPDATE
            StackName:
              Fn::Sub: ${ApplicationName}-qa
            TemplatePath: BuildArtifact::backend/sam/packaged.yaml
            TemplateConfiguration: BuildArtifact::cicd/configs/qa-config.json
            Capabilities: CAPABILITY_NAMED_IAM
            RoleArn:
              Fn::GetAtt:
              - CloudFormationDeployRole
              - Arn
  ProductionPipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name:
        Fn::Sub: ${ApplicationName}-${ApplicationStageName}-production-pipeline
      RoleArn:
        Fn::GetAtt:
        - CodePipelineRole
        - Arn
      ArtifactStore:
        Type: S3
        Location:
          Ref: ArtifactBucket
      Stages:
      - Name: Source
        Actions:
        - Name: SourceAction
          ActionTypeId:
            Category: Source
            Owner: AWS
            Provider: CodeStarSourceConnection
            Version: 1
          OutputArtifacts:
          - Name: SourceArtifact
          Configuration:
            ConnectionArn:
              Ref: GitHubConnectionArn
            FullRepositoryId:
              Ref: GitHubRepoName
            BranchName: main
      - Name: Build
        Actions:
        - Name: BuildAndPackage
          ActionTypeId:
            Category: Build
            Owner: AWS
            Provider: CodeBuild
            Version: 1
          Configuration:
            ProjectName:
              Ref: BuildProject
          InputArtifacts:
          - Name: SourceArtifact
          OutputArtifacts:
          - Name: BuildArtifact
      - Name: ApprovalForProduction
        Actions:
        - Name: ManualApprovalForProd
          ActionTypeId:
            Category: Approval
            Owner: AWS
            Provider: Manual
            Version: 1
          Configuration:
            CustomData: Please review and approve deployment to PRODUCTION environment
      - Name: Deploy
        Actions:
        - Name: DeployProduction
          ActionTypeId:
            Category: Deploy
            Owner: AWS
            Provider: CloudFormation
            Version: 1
          InputArtifacts:
          - Name: BuildArtifact
          Configuration:
            ActionMode: CREATE_UPDATE
            StackName:
              Fn::Sub: ${ApplicationName}-prod
            TemplatePath: BuildArtifact::backend/sam/packaged.yaml
            TemplateConfiguration: BuildArtifact::cicd/configs/prod-config.json
            Capabilities: CAPABILITY_NAMED_IAM
            RoleArn:
              Fn::GetAtt:
              - CloudFormationDeployRole
              - Arn
